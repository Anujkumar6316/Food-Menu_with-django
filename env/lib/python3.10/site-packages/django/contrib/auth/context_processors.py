from typing import Any
from django.contrib.auth import AnonymousUser

class PermLookupDict:
    def __init__(self, user, app_label: str):
        self.user, self.app_label = user, app_label

    def __repr__(self):
        return str(self.user.get_all_permissions())

    def __getitem__(self, perm_name: str):
        if not self.user.has_perm(f"{self.app_label}.{perm_name}"):
            raise KeyError(f"Permission '{self.app_label}.{perm_name}' does not exist.")
        return self.user.has_perm(f"{self.app_label}.{perm_name}")

    def get(self, perm_name: str, default: Any = None):
        try:
            return self[perm_name]
        except KeyError:
            return default

    def __iter__(self):
        raise TypeError("PermLookupDict is not iterable.")

    def __bool__(self):
        return self.user.has_module_perms(self.app_label)

    def __len__(self):
        return sum(1 for perm in self.user.get_all_permissions() if perm.startswith(f"{self.app_label}."))


class PermWrapper:
    def __init__(self, user):
        self.user = user

    def __repr__(self):
        return f"{self.__class__.__qualname__}({self.user!r})"

    def __getitem__(self, app_label: str):
        return PermLookupDict(self.user, app_label)

    def get_app_permissions(self, app_label: str):
        return PermLookupDict(self.user, app_label)

    def __iter__(self):
        raise TypeError("PermWrapper is not iterable.")

    def __contains__(self, perm_name: str):
        """
        Lookup by "someapp" or "someapp.someperm" in perms.
        """
        if "." not in perm_name:
            # The name refers to module.
            return bool(self[perm_name])
        app_label, perm_name = perm_name.split(".", 1)
        return self[app_label][perm_name]


def auth(request):
    """
    Return context variables required by apps that use Django's authentication
    system.

    If there is no 'user' attribute in the request, use AnonymousUser (from
    django.contrib.auth).
    """
    if hasattr(request, "user"):
        user = request.user
    else:
        from django.contrib.auth.models import AnonymousUser

        user = AnonymousUser()

    return {
        "user": user,
        "perms": PermWrapper(user),
    }
